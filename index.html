<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Habits">
    <meta name="theme-color" content="#1a1a2e">
    <title>Habit Tracker</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192.svg">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0d0d0d;
            --bg-secondary: #161616;
            --bg-card: #1e1e1e;
            --accent: #6366f1;
            --accent-light: #818cf8;
            --text-primary: #f5f5f5;
            --text-secondary: #737373;
            --success: #22c55e;
            --warning: #f59e0b;
            --border-radius: 12px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding-bottom: 20px;
        }

        .header {
            background: var(--bg-secondary);
            padding: 12px 16px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid #262626;
        }

        .header h1 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .nav-tabs {
            display: flex;
            justify-content: center;
            gap: 8px;
        }

        .nav-tab {
            background: var(--bg-card);
            border: none;
            color: var(--text-secondary);
            padding: 8px 20px;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .nav-tab.active {
            background: var(--accent);
            color: var(--text-primary);
        }

        .container {
            padding: 12px;
            max-width: 500px;
            margin: 0 auto;
        }

        /* Time Period Selector */
        .time-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 12px;
            justify-content: center;
        }

        .time-btn {
            background: var(--bg-card);
            border: 1px solid #262626;
            color: var(--text-secondary);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .time-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--text-primary);
        }

        .custom-date-range {
            display: flex;
            gap: 10px;
            width: 100%;
            margin-top: 10px;
        }

        .custom-date-range input {
            flex: 1;
            padding: 8px;
            border-radius: 10px;
            border: none;
            background: var(--bg-card);
            color: var(--text-primary);
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }

        .stat-card {
            background: var(--bg-card);
            border-radius: var(--border-radius);
            border: 1px solid #262626;
            padding: 12px;
            text-align: center;
        }

        .stat-card.wide {
            grid-column: span 2;
        }

        .stat-icon {
            font-size: 1.2rem;
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 1.4rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.65rem;
            margin-top: 2px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-trend {
            font-size: 0.65rem;
            margin-top: 4px;
            padding: 2px 6px;
            border-radius: 4px;
            display: inline-block;
        }

        .trend-up {
            background: rgba(34, 197, 94, 0.15);
            color: var(--success);
        }

        .trend-down {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
        }

        .trend-neutral {
            background: rgba(115, 115, 115, 0.15);
            color: var(--text-secondary);
        }

        /* Streak Cards */
        .streak-card {
            border-left: 3px solid var(--success);
        }

        .streak-card.broken {
            border-left-color: #ef4444;
        }

        .streak-fire {
            color: #f97316;
        }

        /* Chart Container */
        .chart-container {
            background: var(--bg-card);
            border-radius: var(--border-radius);
            border: 1px solid #262626;
            padding: 12px;
            margin-bottom: 12px;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .chart-title {
            font-size: 0.85rem;
            font-weight: 600;
        }

        .chart-toggle {
            display: flex;
            gap: 4px;
        }

        .chart-toggle button {
            background: var(--bg-secondary);
            border: 1px solid #262626;
            color: var(--text-secondary);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.6rem;
            cursor: pointer;
        }

        .chart-toggle button.active {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--text-primary);
        }

        .chart-wrapper {
            height: 160px;
            position: relative;
        }

        /* Consistency Bar */
        .consistency-section {
            margin-bottom: 16px;
        }

        .consistency-card {
            background: var(--bg-card);
            border-radius: var(--border-radius);
            border: 1px solid #262626;
            padding: 10px 12px;
            margin-bottom: 6px;
        }

        .consistency-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .consistency-label {
            font-size: 0.75rem;
        }

        .consistency-value {
            font-size: 0.75rem;
            color: var(--success);
            font-weight: 600;
        }

        .consistency-bar {
            height: 4px;
            background: var(--bg-secondary);
            border-radius: 2px;
            overflow: hidden;
        }

        .consistency-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--success));
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        /* Entry Form */
        .entry-form {
            display: none;
        }

        .entry-form.active {
            display: block;
        }

        .overview.active {
            display: block;
        }

        .form-group {
            background: var(--bg-card);
            border-radius: var(--border-radius);
            border: 1px solid #262626;
            padding: 12px 14px;
            margin-bottom: 8px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.85rem;
            color: var(--text-primary);
        }

        .form-input {
            width: 100%;
            max-width: 100%;
            padding: 10px 12px;
            border: 1px solid #262626;
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 0.9rem;
            box-sizing: border-box;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        /* Toggle Switch */
        .toggle-group {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
            flex-shrink: 0;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #262626;
            border-radius: 24px;
            transition: 0.2s;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background: var(--text-secondary);
            border-radius: 50%;
            transition: 0.2s;
        }

        input:checked + .toggle-slider {
            background: var(--success);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(20px);
            background: var(--text-primary);
        }

        /* Submit Button */
        .submit-btn {
            width: 100%;
            padding: 14px;
            background: var(--accent);
            border: none;
            border-radius: var(--border-radius);
            color: var(--text-primary);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s ease;
            margin-top: 12px;
        }

        .submit-btn:hover {
            opacity: 0.9;
        }

        .submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Loading & Messages */
        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--bg-card);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--success);
            color: var(--text-primary);
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 500;
            z-index: 1000;
            animation: slideUp 0.3s ease;
        }

        .toast.error {
            background: #ef4444;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        /* Rating Input (for Stimmung) */
        .rating-input {
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        .rating-btn {
            width: 40px;
            height: 40px;
            border: 1px solid #262626;
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .rating-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--text-primary);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 30px 16px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 2.5rem;
            margin-bottom: 12px;
        }

        /* Login Screen */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .login-box {
            background: var(--bg-card);
            border: 1px solid #262626;
            padding: 32px;
            border-radius: var(--border-radius);
            text-align: center;
            max-width: 320px;
            width: 90%;
        }

        .login-box h2 {
            margin-bottom: 8px;
            font-size: 1.2rem;
        }

        .login-box p {
            color: var(--text-secondary);
            margin-bottom: 20px;
            font-size: 0.8rem;
        }

        .login-box input {
            width: 100%;
            padding: 12px;
            border: 1px solid #262626;
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 0.9rem;
            margin-bottom: 12px;
            box-sizing: border-box;
        }

        .login-box input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .login-error {
            color: #ef4444;
            font-size: 0.8rem;
            margin-bottom: 12px;
            display: none;
        }

        .login-box button {
            width: 100%;
            padding: 12px;
            background: var(--accent);
            border: none;
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
        }

        /* Responsive */
        @media (max-width: 360px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .stat-card.wide {
                grid-column: span 1;
            }
            
            .time-selector {
                gap: 4px;
            }
            
            .time-btn {
                padding: 5px 8px;
                font-size: 0.65rem;
            }
        }

        /* Section headers */
        .section-header {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin: 16px 0 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <h2>üîê Anmeldung</h2>
            <p>Gib dein Passwort ein, um auf den Habit Tracker zuzugreifen.</p>
            <input type="password" id="loginKey" placeholder="Passwort eingeben..." autocomplete="off">
            <p class="login-error" id="loginError">‚ùå Falsches Passwort</p>
            <button onclick="attemptLogin()">Anmelden</button>
        </div>
    </div>

    <header class="header" id="appHeader" style="display: none;">
        <h1>Habit Tracker</h1>
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showView('overview')">√úbersicht</button>
            <button class="nav-tab" onclick="showView('entry')">Eintragen</button>
        </div>
    </header>

    <main class="container" id="appMain" style="display: none;">
        <!-- Overview Section -->
        <section id="overviewSection" class="overview active">
            <div class="loading" id="loadingOverview">
                <div class="spinner"></div>
                <p>Daten werden geladen...</p>
            </div>

            <div id="overviewContent" style="display: none;">
                <!-- Time Period Selector -->
                <div class="time-selector">
                    <button class="time-btn" data-days="7">7 Tage</button>
                    <button class="time-btn" data-days="30">30 Tage</button>
                    <button class="time-btn" data-days="90">90 Tage</button>
                    <button class="time-btn" data-days="365">1 Jahr</button>
                    <button class="time-btn active" data-days="all">Gesamt</button>
                </div>
                <div class="custom-date-range" style="display: none;">
                    <input type="date" id="startDate" placeholder="Von">
                    <input type="date" id="endDate" placeholder="Bis">
                    <button class="time-btn" onclick="applyCustomRange()">Anwenden</button>
                </div>

                <!-- Quick Stats -->
                <div class="stats-grid" id="statsGrid">
                    <!-- Dynamically populated -->
                </div>

                <!-- Streaks -->
                <h3 class="section-header">üî• Streaks</h3>
                <div class="stats-grid" id="streaksGrid">
                    <!-- Dynamically populated -->
                </div>

                <!-- Consistency Section -->
                <h3 class="section-header">üìà Konsistenz (7-Tage)</h3>
                <div class="consistency-section" id="consistencySection">
                    <!-- Dynamically populated -->
                </div>

                <!-- Charts -->
                <div class="chart-container">
                    <div class="chart-header">
                        <span class="chart-title">‚öñÔ∏è Gewicht</span>
                        <div class="chart-toggle" id="weightToggle">
                            <button class="active" data-type="line">Linie</button>
                            <button data-type="ma">+ Trend</button>
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="weightChart"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-header">
                        <span class="chart-title">üë£ Schritte</span>
                        <div class="chart-toggle" id="stepsToggle">
                            <button class="active" data-type="bar">Balken</button>
                            <button data-type="line">Linie</button>
                            <button data-type="ma">+ Trend</button>
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="stepsChart"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-header">
                        <span class="chart-title">üç∫ Alkohol (g)</span>
                        <div class="chart-toggle" id="alcoholToggle">
                            <button class="active" data-type="weekly">Woche</button>
                            <button data-type="daily">Tag</button>
                            <button data-type="monthly">Monat</button>
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="alcoholChart"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-header">
                        <span class="chart-title">üòä Stimmung</span>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="moodChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- Entry Form Section -->
        <section id="entrySection" class="entry-form">
            <form id="habitForm">
                <div class="form-group">
                    <label class="form-label">üìÖ Datum</label>
                    <input type="date" class="form-input" id="entryDate" required>
                </div>

                <div class="form-group">
                    <label class="form-label">‚öñÔ∏è Gewicht (kg)</label>
                    <input type="text" inputmode="decimal" class="form-input" id="gewicht" placeholder="z.B. 75.5">
                </div>

                <div class="form-group toggle-group">
                    <label class="form-label">üö´ No Porn</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="noPorn">
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="form-group toggle-group">
                    <label class="form-label">üáµüá± Polnisch gelernt</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="polnisch">
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="form-group toggle-group">
                    <label class="form-label">üèãÔ∏è Sport gemacht</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="sport">
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="form-group toggle-group">
                    <label class="form-label">ü¶∑ Z√§hne geputzt/geflosst</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="zaehne">
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="form-group toggle-group">
                    <label class="form-label">üíä Kreatin genommen</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="kreatin">
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="form-group">
                    <label class="form-label">üç∫ Alkohol (g)</label>
                    <input type="text" inputmode="numeric" class="form-input" id="alkohol" placeholder="0" value="0">
                </div>

                <div class="form-group">
                    <label class="form-label">üë£ Schritte</label>
                    <input type="text" inputmode="numeric" class="form-input" id="schritte" placeholder="z.B. 8000">
                </div>

                <div class="form-group">
                    <label class="form-label">üò¥ Schlafstunden</label>
                    <input type="text" inputmode="decimal" class="form-input" id="schlaf" placeholder="z.B. 7.5">
                </div>

                <div class="form-group">
                    <label class="form-label">üòä Stimmung (1-5)</label>
                    <div class="rating-input">
                        <button type="button" class="rating-btn" data-value="1">1</button>
                        <button type="button" class="rating-btn" data-value="2">2</button>
                        <button type="button" class="rating-btn" data-value="3">3</button>
                        <button type="button" class="rating-btn" data-value="4">4</button>
                        <button type="button" class="rating-btn" data-value="5">5</button>
                    </div>
                    <input type="hidden" id="stimmung" value="">
                </div>

                <div class="form-group">
                    <label class="form-label">üì± Bildschirmzeit (h)</label>
                    <input type="text" inputmode="decimal" class="form-input" id="bildschirmzeit" placeholder="z.B. 3.5">
                </div>

                <div class="form-group">
                    <label class="form-label">üíº Arbeitszeit (h)</label>
                    <input type="text" inputmode="decimal" class="form-input" id="arbeitszeit" placeholder="z.B. 8">
                </div>

                <div class="form-group">
                    <label class="form-label">üìù Notizen</label>
                    <textarea class="form-input" id="notizen" rows="3" placeholder="Optionale Notizen..."></textarea>
                </div>

                <button type="submit" class="submit-btn" id="submitBtn">
                    üíæ Speichern
                </button>
            </form>
        </section>
    </main>

    <script>
        // Configuration
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxa_pVc5UbhUkUkGDbC5qaVBiCUANGQVYtLrbM4k8RWn69VTROicD61U187A-zJiOfduw/exec';
        
        // Global state
        let allData = [];
        let filteredData = [];
        let charts = {};
        let currentTimePeriod = 'all';
        let secretKey = '';

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Check if we have a saved key
            const savedKey = localStorage.getItem('habitTrackerKey');
            if (savedKey) {
                secretKey = savedKey;
                showApp();
            }
            
            // Allow Enter key to submit login
            document.getElementById('loginKey').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') attemptLogin();
            });
        });

        async function attemptLogin() {
            const keyInput = document.getElementById('loginKey');
            const errorEl = document.getElementById('loginError');
            const key = keyInput.value.trim();
            
            if (!key) return;
            
            // Test the key by making a request
            try {
                const response = await fetch(`${APPS_SCRIPT_URL}?action=read&key=${encodeURIComponent(key)}`);
                const result = await response.json();
                
                if (result.error && result.error.includes('Unauthorized')) {
                    errorEl.style.display = 'block';
                    keyInput.value = '';
                    return;
                }
                
                // Key is valid - save it
                secretKey = key;
                localStorage.setItem('habitTrackerKey', key);
                errorEl.style.display = 'none';
                
                // Process the data we already got
                allData = result.rows || [];
                allData.sort((a, b) => new Date(b.Datum) - new Date(a.Datum));
                filterDataByPeriod();
                
                showApp();
                updateOverview();
            } catch (error) {
                errorEl.textContent = '‚ùå Verbindungsfehler';
                errorEl.style.display = 'block';
            }
        }

        function showApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('appHeader').style.display = 'block';
            document.getElementById('appMain').style.display = 'block';
            
            setCurrentDate();
            setupEventListeners();
            
            // Load data if we don't have it yet
            if (allData.length === 0) {
                loadData();
            } else {
                document.getElementById('loadingOverview').style.display = 'none';
                document.getElementById('overviewContent').style.display = 'block';
            }
        }

        function logout() {
            localStorage.removeItem('habitTrackerKey');
            secretKey = '';
            allData = [];
            filteredData = [];
            location.reload();
        }

        function setCurrentDate() {
            const now = new Date();
            document.getElementById('entryDate').value = now.toISOString().split('T')[0];
        }
        
        // Parse number that accepts both . and , as decimal separator
        function parseDecimal(value) {
            if (!value || value === '') return null;
            const normalized = String(value).replace(',', '.');
            const num = parseFloat(normalized);
            return isNaN(num) ? null : num;
        }

        function setupEventListeners() {
            // Time period buttons
            document.querySelectorAll('.time-btn[data-days]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentTimePeriod = btn.dataset.days;
                    filterDataByPeriod();
                    updateOverview();
                });
            });

            // Rating buttons
            document.querySelectorAll('.rating-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.rating-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    document.getElementById('stimmung').value = btn.dataset.value;
                });
            });

            // Form submission
            document.getElementById('habitForm').addEventListener('submit', handleFormSubmit);

            // Chart toggles
            setupChartToggles();
        }

        function setupChartToggles() {
            ['weightToggle', 'stepsToggle', 'alcoholToggle'].forEach(toggleId => {
                const toggle = document.getElementById(toggleId);
                if (toggle) {
                    toggle.querySelectorAll('button').forEach(btn => {
                        btn.addEventListener('click', () => {
                            toggle.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                            btn.classList.add('active');
                            updateCharts();
                        });
                    });
                }
            });
        }

        function showView(view) {
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            document.getElementById('overviewSection').style.display = view === 'overview' ? 'block' : 'none';
            document.getElementById('entrySection').style.display = view === 'entry' ? 'block' : 'none';
            
            if (view === 'overview') {
                updateOverview();
            }
        }

        async function loadData() {
            try {
                const response = await fetch(`${APPS_SCRIPT_URL}?action=read&key=${encodeURIComponent(secretKey)}`);
                const result = await response.json();
                
                if (result.error) {
                    if (result.error.includes('Unauthorized')) {
                        // Key is invalid, logout
                        logout();
                        return;
                    }
                    throw new Error(result.error);
                }

                allData = result.rows || [];
                // Sort by date descending
                allData.sort((a, b) => new Date(b.Datum) - new Date(a.Datum));
                
                filterDataByPeriod();
                
                document.getElementById('loadingOverview').style.display = 'none';
                document.getElementById('overviewContent').style.display = 'block';
                
                updateOverview();
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loadingOverview').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üòï</div>
                        <p>Fehler beim Laden der Daten</p>
                        <p style="font-size: 0.8rem; margin-top: 10px;">${error.message}</p>
                        <button class="submit-btn" style="margin-top: 20px; width: auto; padding: 10px 30px;" onclick="loadData()">
                            üîÑ Erneut versuchen
                        </button>
                    </div>
                `;
            }
        }

        function filterDataByPeriod() {
            if (currentTimePeriod === 'all') {
                filteredData = [...allData];
            } else {
                const days = parseInt(currentTimePeriod);
                const cutoffDate = new Date();
                cutoffDate.setDate(cutoffDate.getDate() - days);
                
                filteredData = allData.filter(row => {
                    const rowDate = new Date(row.Datum);
                    return rowDate >= cutoffDate;
                });
            }
        }

        function updateOverview() {
            if (filteredData.length === 0) {
                document.getElementById('statsGrid').innerHTML = `
                    <div class="stat-card wide">
                        <div class="empty-state">
                            <div class="empty-state-icon">üìä</div>
                            <p>Noch keine Daten vorhanden</p>
                            <p style="font-size: 0.8rem; margin-top: 10px;">F√ºge deinen ersten Eintrag hinzu!</p>
                        </div>
                    </div>
                `;
                document.getElementById('streaksGrid').innerHTML = '';
                document.getElementById('consistencySection').innerHTML = '';
                return;
            }

            updateStats();
            updateStreaks();
            updateConsistency();
            updateCharts();
        }

        function updateStats() {
            const latest = filteredData[0] || {};
            const statsHtml = `
                <div class="stat-card">
                    <div class="stat-icon">‚öñÔ∏è</div>
                    <div class="stat-value">${parseDecimal(latest.Gewicht)?.toFixed(1) || '-'}</div>
                    <div class="stat-label">Gewicht (kg)</div>
                    ${getWeightTrend()}
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üë£</div>
                    <div class="stat-value">${formatNumber(latest.Schritte) || '-'}</div>
                    <div class="stat-label">Schritte</div>
                    ${getStepsTrend()}
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üò¥</div>
                    <div class="stat-value">${parseDecimal(latest.Schlaf)?.toFixed(1) || '-'}</div>
                    <div class="stat-label">Schlaf (h)</div>
                    ${getSleepAverage()}
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üíº</div>
                    <div class="stat-value">${parseDecimal(latest.Arbeitszeit)?.toFixed(1) || '-'}</div>
                    <div class="stat-label">Arbeit (h)</div>
                    ${getWorkAverage()}
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üòä</div>
                    <div class="stat-value">${getMoodEmoji(latest.Stimmung)}</div>
                    <div class="stat-label">Stimmung</div>
                    ${getMoodAverage()}
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üì±</div>
                    <div class="stat-value">${parseDecimal(latest.Bildschirmzeit)?.toFixed(1) || '-'}</div>
                    <div class="stat-label">Screen (h)</div>
                </div>
            `;
            document.getElementById('statsGrid').innerHTML = statsHtml;
        }

        function getWeightTrend() {
            const weights = filteredData.filter(d => d.Gewicht).map(d => parseDecimal(d.Gewicht)).filter(w => w !== null);
            if (weights.length < 2) return '';
            
            const diff = weights[0] - weights[weights.length - 1];
            const cls = diff < 0 ? 'trend-down' : diff > 0 ? 'trend-up' : 'trend-neutral';
            const arrow = diff < 0 ? '‚Üì' : diff > 0 ? '‚Üë' : '‚Üí';
            return `<div class="stat-trend ${cls}">${arrow} ${Math.abs(diff).toFixed(1)} kg</div>`;
        }

        function getStepsTrend() {
            const steps = filteredData.filter(d => d.Schritte).map(d => parseInt(String(d.Schritte).replace(/\D/g, ''))).filter(s => !isNaN(s));
            if (steps.length === 0) return '';
            const avg = Math.round(steps.reduce((a, b) => a + b, 0) / steps.length);
            return `<div class="stat-trend trend-neutral">‚åÄ ${formatNumber(avg)}/Tag</div>`;
        }

        function getSleepAverage() {
            const sleep = filteredData.filter(d => d.Schlaf).map(d => parseDecimal(d.Schlaf)).filter(s => s !== null);
            if (sleep.length === 0) return '';
            const avg = (sleep.reduce((a, b) => a + b, 0) / sleep.length).toFixed(1);
            return `<div class="stat-trend trend-neutral">‚åÄ ${avg}h</div>`;
        }

        function getMoodEmoji(mood) {
            const emojis = { 1: 'üò¢', 2: 'üòï', 3: 'üòê', 4: 'üôÇ', 5: 'üòä' };
            return emojis[mood] || '-';
        }

        function getMoodAverage() {
            const moods = filteredData.filter(d => d.Stimmung).map(d => parseInt(d.Stimmung));
            if (moods.length === 0) return '';
            const avg = (moods.reduce((a, b) => a + b, 0) / moods.length).toFixed(1);
            return `<div class="stat-trend trend-neutral">‚åÄ ${avg}</div>`;
        }

        function getTotalAlcohol() {
            const alcohol = filteredData.filter(d => d.Alkohol).map(d => parseDecimal(d.Alkohol) || 0);
            return alcohol.reduce((a, b) => a + b, 0);
        }

        function getWorkAverage() {
            const work = filteredData.filter(d => d.Arbeitszeit).map(d => parseDecimal(d.Arbeitszeit)).filter(w => w !== null);
            if (work.length === 0) return '';
            const avg = (work.reduce((a, b) => a + b, 0) / work.length).toFixed(1);
            return `<div class="stat-trend trend-neutral">‚åÄ ${avg}h</div>`;
        }

        function updateStreaks() {
            const streaks = {
                'NoPorn': { icon: 'üö´', label: 'No Porn' },
                'Polnisch': { icon: 'üáµüá±', label: 'Polnisch' },
                'Sport': { icon: 'üèãÔ∏è', label: 'Sport' },
                'Zaehne': { icon: 'ü¶∑', label: 'Z√§hne' },
                'Kreatin': { icon: 'üíä', label: 'Kreatin' }
            };

            let html = '';
            for (const [key, info] of Object.entries(streaks)) {
                const streak = calculateStreak(key);
                const isBroken = streak.current === 0 && filteredData.length > 0;
                html += `
                    <div class="stat-card streak-card ${isBroken ? 'broken' : ''}">
                        <div class="stat-icon">${info.icon}</div>
                        <div class="stat-value">
                            <span class="streak-fire">${streak.current > 0 ? 'üî•' : ''}</span> 
                            ${streak.current}
                        </div>
                        <div class="stat-label">${info.label} Streak</div>
                        <div class="stat-trend trend-neutral">Best: ${streak.best}</div>
                    </div>
                `;
            }
            document.getElementById('streaksGrid').innerHTML = html;
        }

        function calculateStreak(field) {
            const sortedData = [...filteredData].sort((a, b) => new Date(b.Datum) - new Date(a.Datum));
            let current = 0;
            let best = 0;
            let tempStreak = 0;

            // Calculate current streak (from most recent)
            for (const row of sortedData) {
                const value = row[field];
                if (value === 'Ja' || value === 'ja' || value === true || value === 1 || value === '1') {
                    current++;
                } else {
                    break;
                }
            }

            // Calculate best streak
            for (const row of sortedData) {
                const value = row[field];
                if (value === 'Ja' || value === 'ja' || value === true || value === 1 || value === '1') {
                    tempStreak++;
                    best = Math.max(best, tempStreak);
                } else {
                    tempStreak = 0;
                }
            }

            return { current, best };
        }

        function updateConsistency() {
            const habits = {
                'Sport': { icon: 'üèãÔ∏è', label: 'Sport' },
                'Polnisch': { icon: 'üáµüá±', label: 'Polnisch lernen' },
                'NoPorn': { icon: 'üö´', label: 'No Porn' },
                'Zaehne': { icon: 'ü¶∑', label: 'Zahnpflege' },
                'Kreatin': { icon: 'üíä', label: 'Kreatin' }
            };

            let html = '';
            for (const [key, info] of Object.entries(habits)) {
                const consistency = calculateConsistency(key);
                html += `
                    <div class="consistency-card">
                        <div class="consistency-header">
                            <span class="consistency-label">${info.icon} ${info.label}</span>
                            <span class="consistency-value">${consistency}%</span>
                        </div>
                        <div class="consistency-bar">
                            <div class="consistency-fill" style="width: ${consistency}%"></div>
                        </div>
                    </div>
                `;
            }
            document.getElementById('consistencySection').innerHTML = html;
        }

        function calculateConsistency(field) {
            // Use last 7 days or all data if less
            const last7 = filteredData.slice(0, Math.min(7, filteredData.length));
            if (last7.length === 0) return 0;

            const positiveCount = last7.filter(row => {
                const value = row[field];
                return value === 'Ja' || value === 'ja' || value === true || value === 1 || value === '1';
            }).length;

            return Math.round((positiveCount / last7.length) * 100);
        }

        function updateCharts() {
            const reversedData = [...filteredData].reverse(); // Oldest first for charts
            
            updateWeightChart(reversedData);
            updateStepsChart(reversedData);
            updateAlcoholChart(reversedData);
            updateMoodChart(reversedData);
        }

        function updateWeightChart(data) {
            const ctx = document.getElementById('weightChart').getContext('2d');
            const showMA = document.querySelector('#weightToggle button.active')?.dataset.type === 'ma';
            
            const labels = data.map(d => d.Datum);
            const values = data.map(d => parseDecimal(d.Gewicht));
            
            const datasets = [{
                label: 'Gewicht',
                data: values,
                borderColor: '#e94560',
                backgroundColor: 'rgba(233, 69, 96, 0.1)',
                fill: true,
                tension: 0.3,
                spanGaps: true
            }];

            if (showMA) {
                datasets.push({
                    label: '7-Tage Trend',
                    data: calculateMovingAverage(values, 7),
                    borderColor: '#4ecca3',
                    borderDash: [5, 5],
                    fill: false,
                    tension: 0.3,
                    pointRadius: 0,
                    spanGaps: true
                });
            }

            if (charts.weight) charts.weight.destroy();
            charts.weight = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets },
                options: getChartOptions('kg')
            });
        }

        function updateStepsChart(data) {
            const ctx = document.getElementById('stepsChart').getContext('2d');
            const activeType = document.querySelector('#stepsToggle button.active')?.dataset.type || 'bar';
            
            const labels = data.map(d => d.Datum);
            const values = data.map(d => {
                const val = parseInt(String(d.Schritte).replace(/\D/g, ''));
                return isNaN(val) ? null : val;
            });
            
            const datasets = [{
                label: 'Schritte',
                data: values,
                borderColor: '#4ecca3',
                backgroundColor: activeType === 'bar' ? 'rgba(78, 204, 163, 0.6)' : 'rgba(78, 204, 163, 0.1)',
                fill: activeType !== 'bar',
                tension: 0.3,
                spanGaps: true
            }];

            if (activeType === 'ma') {
                datasets.push({
                    label: '7-Tage Trend',
                    data: calculateMovingAverage(values, 7),
                    borderColor: '#e94560',
                    borderDash: [5, 5],
                    fill: false,
                    tension: 0.3,
                    pointRadius: 0,
                    type: 'line',
                    spanGaps: true
                });
            }

            if (charts.steps) charts.steps.destroy();
            charts.steps = new Chart(ctx, {
                type: activeType === 'bar' ? 'bar' : 'line',
                data: { labels, datasets },
                options: getChartOptions('')
            });
        }

        function updateAlcoholChart(data) {
            const ctx = document.getElementById('alcoholChart').getContext('2d');
            const granularity = document.querySelector('#alcoholToggle button.active')?.dataset.type || 'weekly';
            
            let chartData;
            if (granularity === 'daily') {
                chartData = {
                    labels: data.map(d => d.Datum),
                    values: data.map(d => parseDecimal(d.Alkohol) || 0)
                };
            } else if (granularity === 'weekly') {
                chartData = aggregateByPeriod(data, 'week');
            } else {
                chartData = aggregateByPeriod(data, 'month');
            }

            if (charts.alcohol) charts.alcohol.destroy();
            charts.alcohol = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        label: 'Alkohol (g)',
                        data: chartData.values,
                        backgroundColor: 'rgba(255, 193, 7, 0.6)',
                        borderColor: '#ffc107',
                        borderWidth: 1
                    }]
                },
                options: getChartOptions('g')
            });
        }

        function updateMoodChart(data) {
            const ctx = document.getElementById('moodChart').getContext('2d');
            const labels = data.map(d => d.Datum);
            const values = data.map(d => parseInt(d.Stimmung) || null);
            
            if (charts.mood) charts.mood.destroy();
            charts.mood = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'Stimmung',
                        data: values,
                        borderColor: '#ff6b6b',
                        backgroundColor: 'rgba(255, 107, 107, 0.1)',
                        fill: true,
                        tension: 0.3,
                        spanGaps: true
                    }, {
                        label: '7-Tage Trend',
                        data: calculateMovingAverage(values, 7),
                        borderColor: '#4ecca3',
                        borderDash: [5, 5],
                        fill: false,
                        tension: 0.3,
                        pointRadius: 0,
                        spanGaps: true
                    }]
                },
                options: {
                    ...getChartOptions(''),
                    scales: {
                        ...getChartOptions('').scales,
                        y: {
                            ...getChartOptions('').scales.y,
                            min: 1,
                            max: 5
                        }
                    }
                }
            });
        }

        function calculateMovingAverage(data, window) {
            return data.map((_, idx, arr) => {
                if (idx < window - 1) return null;
                const slice = arr.slice(idx - window + 1, idx + 1).filter(v => v !== null);
                if (slice.length === 0) return null;
                return slice.reduce((a, b) => a + b, 0) / slice.length;
            });
        }

        function aggregateByPeriod(data, period) {
            const grouped = {};
            
            data.forEach(row => {
                const date = new Date(row.Datum);
                let key;
                
                if (period === 'week') {
                    const weekStart = new Date(date);
                    weekStart.setDate(date.getDate() - date.getDay());
                    key = weekStart.toISOString().split('T')[0];
                } else {
                    key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                }
                
                if (!grouped[key]) grouped[key] = 0;
                grouped[key] += parseDecimal(row.Alkohol) || 0;
            });
            
            const sortedKeys = Object.keys(grouped).sort();
            return {
                labels: sortedKeys,
                values: sortedKeys.map(k => grouped[k])
            };
        }

        function getChartOptions(unit) {
            return {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: { color: '#a0a0a0', boxWidth: 12 }
                    }
                },
                scales: {
                    x: {
                        ticks: { color: '#a0a0a0', maxRotation: 45 },
                        grid: { color: 'rgba(160, 160, 160, 0.1)' }
                    },
                    y: {
                        ticks: { 
                            color: '#a0a0a0',
                            callback: (value) => unit ? `${value}${unit}` : value
                        },
                        grid: { color: 'rgba(160, 160, 160, 0.1)' }
                    }
                }
            };
        }

        function formatNumber(num) {
            if (!num) return null;
            return parseInt(num).toLocaleString('de-DE');
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = '‚è≥ Speichern...';

            const data = {
                Datum: document.getElementById('entryDate').value,
                Gewicht: document.getElementById('gewicht').value.replace(',', '.') || '',
                NoPorn: document.getElementById('noPorn').checked ? 'Ja' : 'Nein',
                Polnisch: document.getElementById('polnisch').checked ? 'Ja' : 'Nein',
                Sport: document.getElementById('sport').checked ? 'Ja' : 'Nein',
                Zaehne: document.getElementById('zaehne').checked ? 'Ja' : 'Nein',
                Kreatin: document.getElementById('kreatin').checked ? 'Ja' : 'Nein',
                Alkohol: document.getElementById('alkohol').value.replace(',', '.') || '0',
                Schritte: document.getElementById('schritte').value || '',
                Schlaf: document.getElementById('schlaf').value.replace(',', '.') || '',
                Stimmung: document.getElementById('stimmung').value || '',
                Bildschirmzeit: document.getElementById('bildschirmzeit').value.replace(',', '.') || '',
                Arbeitszeit: document.getElementById('arbeitszeit').value.replace(',', '.') || '',
                Notizen: document.getElementById('notizen').value || ''
            };

            try {
                const response = await fetch(`${APPS_SCRIPT_URL}?action=write&key=${encodeURIComponent(secretKey)}&data=${encodeURIComponent(JSON.stringify(data))}`);
                const result = await response.json();
                
                if (result.error) {
                    throw new Error(result.error);
                }

                showToast('‚úÖ Erfolgreich gespeichert!');
                resetForm();
                loadData(); // Reload data
            } catch (error) {
                console.error('Error saving:', error);
                showToast('‚ùå Fehler beim Speichern', true);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'üíæ Speichern';
            }
        }

        function resetForm() {
            document.getElementById('habitForm').reset();
            document.getElementById('entryDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('alkohol').value = '0';
            document.getElementById('stimmung').value = '';
            document.querySelectorAll('.rating-btn').forEach(b => b.classList.remove('active'));
        }

        function showToast(message, isError = false) {
            const toast = document.createElement('div');
            toast.className = `toast ${isError ? 'error' : ''}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.remove(), 3000);
        }

        // Register service worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(console.error);
        }
    </script>
</body>
</html>
